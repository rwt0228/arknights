<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="never">
    <title>明日方舟作战记录馆</title>
    <!-- import CSS -->
    <link rel="stylesheet" href="/css/element-ui.css">
    <link rel="stylesheet" href="/ak.css">
    <!--<script src="/js/vue.min.js"></script>-->
    <script src="/operators.js"></script>
    <script src="/stage.js"></script>
    <script src="/share.js"></script>
    <script src="/js/vue.js"></script>
    <script src="/js/elemeui.js"></script>
    <script src="/js/vue-router.js"></script>
    <script src="/js/axios.min.js"></script>
</head>
<body>
<div id="app">
    <mmenu></mmenu>
</div>
<template id="my-menu">
    <div>
        <el-menu
                :default-active="activeIndex"
                class="el-menu-demo"
                mode="horizontal"
                background-color="#545c64"
                text-color="#fff"
                active-text-color="#ffd04b">
            <span class="my-title">明日方舟作战记录馆</span>
            <el-menu-item index="1">
                <router-link to="/抄作业">我要抄作业</router-link>
            </el-menu-item>
            <el-menu-item index="2">
                <router-link to="/写作业">我要写作业</router-link>
            </el-menu-item>
        </el-menu>
        <router-view></router-view>
    </div>
</template>
<template id="copy">
    <div style="padding: 30px">
        <div>
            <el-form ref="query_form" :model="query_form" label-width="90px">
                <el-row>
                    <el-col :span="8">
                        <el-form-item label="关卡类型">
                            <el-select style="width: 100%;" v-model="stage_type" @change="changeType()"
                                       placeholder="请选择关卡类型">
                                <el-option v-for="type in stage_type_list" :label="type.description"
                                           :value="type.description" v-bind:key="type.id"></el-option>
                            </el-select>
                        </el-form-item>
                    </el-col>
                    <el-col :span="8">
                        <el-form-item label="关卡代号">
                            <el-select style="width: 100%;" v-model="query_form.stage_id" placeholder="请选择关卡代号">
                                <el-option v-for="s in stages" :label="s.code" :value="s.id" v-bind:key="s.id"></el-option>
                            </el-select>
                        </el-form-item>
                    </el-col>
                    <el-col :span="8" v-show="query_form.is_tag">
                        <el-form-item label="最低等级">
                            <el-select style="width: 100%;" v-model="query_form.total_tag" placeholder="请选择合约等级">
                                <el-option v-for="i in 35" :label="i" :value="i" v-bind:key="i"></el-option>
                            </el-select>
                        </el-form-item>
                    </el-col>
                </el-row>
                <el-row>
                    <el-col :span="8">
                        <el-form-item label="排除干员">
                            <el-input v-model="query_form.exclude_txt" @click.native="clickEclude" placeholder="选择自己没有的干员"></el-input>
                        </el-form-item>
                    </el-col>
                    <el-col :span="8">
                        <el-form-item label="支援干员">
                            <el-input v-model="query_form.aid_txt" @click.native="clickAid" placeholder="选择可供支援的好友干员"></el-input>
                        </el-form-item>
                    </el-col>
                    <el-col :span="8">
                        <el-button type="primary" style="margin-left:20px" @click="query">点击查询</el-button>
                    </el-col>
                </el-row>

            </el-form>

            <div style="height: 20px;"></div>

            <el-table :data="tableData" border style="width: 100%">
                <el-table-column align="center" prop="aid" label="av号" ></el-table-column>
                <el-table-column align="center" prop="upName" label="up主" ></el-table-column>
                <el-table-column align="center" prop="title" label="标题">
                    <template slot-scope="scope">
                        <span :title="scope.row.title">{{scope.row.title | longTxt}}</span>
                    </template>
                </el-table-column>
                <el-table-column align="center" prop="img" label="封面">
                    <template slot-scope="scope">
                        <img :src="scope.row.imgUrl" style="height: 90px"/>
                    </template>
                </el-table-column>
                <el-table-column align="center" prop="desc" label="简介">
                    <template slot-scope="scope">
                        <span :title="scope.row.desc">{{scope.row.desc | longTxt}}</span>
                    </template>
                </el-table-column>
                <el-table-column align="center" prop="stage" label="关卡代号"  ></el-table-column>
                <el-table-column align="center" prop="totalTag" label="合约等级"  >
                    <template slot-scope="scope">
                        <span :title="scope.row.totalTag">{{scope.row.totalTag | tag}}</span>
                    </template>
                </el-table-column>
                <el-table-column align="center" prop="aaa" label="干员列表">
                    <template slot-scope="scope">
                        <operator-table-item :operators="scope.row.operators"></operator-table-item>
                    </template>
                </el-table-column>
                <el-table-column align="center" prop="avgLevel" label="平均等级"  ></el-table-column>
                <el-table-column align="center" prop="avgStar" label="平均星数"  ></el-table-column>
                <el-table-column align="center" label="操作"  >
                    <template slot-scope="scope">
                        <el-button size="mini" type="primary" @click="jumpBili(scope.$index, scope.row)">跳转B站</el-button>
                    </template>
                </el-table-column>
            </el-table>
        </div>

        <exclude-operator ref="exclude_operator" @confirm="confirmExclude"></exclude-operator>
        <aid-operator ref="aid_operator" @confirm="confirmAid"></aid-operator>

    </div>
</template>
<template id="operatorTableItem">
    <div>
        <div style="position: relative;">
        <span style="color: blue; text-decoration: underline; cursor: pointer;" @click="visible=true">
            {{names}}
        </span>
        </div>
        <el-dialog title="干员信息详情" :visible.sync="visible" width="50%">
            <div class="operator-row">
                <span style="width: 40px;"></span>
                <span style="width: 100px">姓名</span>
                <span style="width: 130px">等级</span>
                <span style="width: 130px">技能</span>
                <span style="width: 100px">潜能</span>
            </div>
            <div class="operator-row" v-for="o in operators">
                <img :src="o.avatar" style="height:40px;display: inline-block;vertical-align: top"/>
                <span style="width: 100px">{{o.name}}</span>
                <span style="width: 130px">{{o.jingying | jingying}}{{o.level | level}}</span>
                <span style="width: 130px">{{o.skill |skill }}-{{o.skillLevel | skillLevel}}</span>
                <span style="width: 100px">{{o.qianneng | qianneng}}</span>
            </div>
        </el-dialog>
    </div>
</template>
<template id="excludeOperator">
    <div>
        <el-dialog title="请选择不参战干员" :visible.sync="visible" width="30%" :close-on-click-modal=false>
            <el-input placeholder="输入关键字进行过滤" v-model="filterText"></el-input>
            <el-tree :data="data" accordion show-checkbox node-key="id" ref="tree" highlight-current
                     :props="defaultProps" :filter-node-method="filterNode">
              <span class="custom-tree-node" slot-scope="{ node, data }">
                <span><img style="height: 19.2px; vertical-align: top;" :src="data.avatar"/></span>
                <span>{{ node.label }}</span>
              </span>
            </el-tree>
            <span slot="footer" class="dialog-footer">
                <el-button @click="visible = false">取 消</el-button>
                <el-button type="primary" @click="confirm">确 定</el-button>
             </span>
        </el-dialog>
    </div>
</template>
<template id="aidOperator">
    <div>
        <el-dialog title="请选择好友支援干员" :visible.sync="visible" width="30%" :close-on-click-modal=false>
            <el-input placeholder="输入关键字进行过滤" v-model="filterText"></el-input>
            <el-tree :data="data" accordion show-checkbox node-key="id" ref="tree" highlight-current
                     :props="defaultProps" :filter-node-method="filterNode">
              <span class="custom-tree-node" slot-scope="{ node, data }">
                <span><img style="height: 19.2px; vertical-align: top;" :src="data.avatar"/></span>
                <span>{{ node.label }}</span>
              </span>
            </el-tree>
            <span slot="footer" class="dialog-footer">
                <el-button @click="visible = false">取 消</el-button>
                <el-button type="primary" @click="confirm">确 定</el-button>
             </span>
        </el-dialog>
    </div>
</template>

<!--我要写作业的视图-->
<template id="share">
    <div style="padding: 30px; width: 80%; margin: 0 auto">
        <!--表单-->
        <el-form ref="share_form" :rules="rules" :model="share_form" label-width="90px">
            <el-row>
                <el-col :span="8">
                    <el-form-item label="视频av号" prop="aid">
                        <el-input v-model="share_form.aid" ></el-input>
                    </el-form-item>
                </el-col>
                <el-col :span="8">
                    <el-form-item label="视频类型" prop="type">
                        <el-select style="width: 100%;" v-model="share_form.type" placeholder="请选择视频类型">
                            <el-option label="作业向" value="1"></el-option>
                            <el-option label="论文向" value="2"></el-option>
                            <el-option label="迫害向" value="3"></el-option>
                            <el-option label="其他" value="4"></el-option>
                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col :span="8">
                    <el-button type="success" @click="clickVideoInfo">预览视频信息</el-button>
                </el-col>
            </el-row>
            <el-row>
                <el-col :span="8">
                    <el-form-item label="关卡类型">
                        <el-select style="width: 100%;" v-model="stage_type" @change="changeType()"
                                   placeholder="请选择关卡类型">
                            <el-option v-for="type in stage_type_list" :label="type.description"
                                       :value="type.description" v-bind:key="type.id"></el-option>
                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col :span="8">
                    <el-form-item label="关卡代号" prop="stage_id">
                        <el-select style="width: 100%;" v-model="share_form.stage_id" placeholder="请选择关卡代号">
                            <el-option v-for="s in stages" :label="s.code" :value="s.id" v-bind:key="s.id"></el-option>
                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col :span="8" v-show="share_form.is_tag">
                    <el-form-item label="合约等级">
                        <el-select style="width: 100%;" v-model="share_form.total_tag" placeholder="请选择合约等级">
                            <el-option v-for="i in 35" :label="i" :value="i" v-bind:key="i"></el-option>
                        </el-select>
                    </el-form-item>
                </el-col>
            </el-row>
            <el-form-item label="选择干员">
                <el-button type="primary" @click="clickOperator">点击选择</el-button>
                <span v-show="operators.length > 0" style="color: red">注：精英化和等级为必填，技能、技能等级、潜能等级可以不用填</span>
            </el-form-item>
            <table class="operator-table" cellpadding="0" cellspacing="0" border="1">
                <tr v-for="o in operators">
                    <td style="width: 40px">
                        <img :src="o.avatar" style="height:40px;display: inline-block;"/>
                    </td>
                    <td class="name-label">{{o.name}}</td>
                    <td>
                        <el-select style="width: 100%;" v-model="o.jingying" placeholder="精英化(必填)">
                            <el-option label="精零" value="0"></el-option>
                            <el-option label="精一" value="1"></el-option>
                            <el-option label="精二" value="2"></el-option>
                        </el-select>
                    </td>
                    <td>
                        <el-select style="width: 100%;" v-model="o.level" placeholder="等级(必填)">
                            <el-option v-for="i in 90" :label="i" :value="i" v-bind:key="i"></el-option>
                        </el-select>
                    </td>
                    <td>
                        <el-select style="width: 100%;" v-model="o.skill" placeholder="选择技能">
                            <el-option label="选择技能" value=""></el-option>
                            <el-option label="一技能" value="1"></el-option>
                            <el-option label="二技能" value="2"></el-option>
                            <el-option label="三技能" value="3"></el-option>
                        </el-select>
                    </td>
                    <td>
                        <el-select style="width: 100%;" v-model="o.skill_level" placeholder="技能等级">
                            <el-option label="技能等级" value=""></el-option>
                            <el-option v-for="i in 7" :label="i" :value="i" v-bind:key="i"></el-option>
                            <el-option label="专精一" value="8"></el-option>
                            <el-option label="专精二" value="9"></el-option>
                            <el-option label="专精三" value="10"></el-option>
                        </el-select>
                    </td>
                    <td>
                        <el-select style="width: 100%;" v-model="o.qianneng" placeholder="潜能等级">
                            <el-option label="潜能等级" value=""></el-option>
                            <el-option label="零潜" value="0"></el-option>
                            <el-option label="一潜" value="1"></el-option>
                            <el-option label="二潜" value="2"></el-option>
                            <el-option label="三潜" value="3"></el-option>
                            <el-option label="四潜" value="4"></el-option>
                            <el-option label="满潜" value="5"></el-option>
                        </el-select>
                    </td>
                </tr>
            </table>

        </el-form>
        <el-button style="margin: 20px;" type="primary" @click="onSubmit">上传作业</el-button>
        <!--选择关卡-->
        <select-operator ref="select_operator" @confirm="confirmOperators"></select-operator>

        <video_info ref="video_info" ></video_info>
    </div>
</template>
<template id="selectOperator">
    <div>
        <el-dialog title="请选择干员" :visible.sync="visible" width="30%" :close-on-click-modal=false>
            <el-input placeholder="输入关键字进行过滤" v-model="filterText"></el-input>
            <el-tree :data="data" accordion show-checkbox node-key="id" ref="tree" highlight-current
                     :props="defaultProps" :filter-node-method="filterNode">
              <span class="custom-tree-node" slot-scope="{ node, data }">
                <span><img style="height: 19.2px; vertical-align: top;" :src="data.avatar"/></span>
                <span>{{ node.label }}</span>
              </span>
            </el-tree>
            <span slot="footer" class="dialog-footer">
                <el-button @click="visible = false">取 消</el-button>
                <el-button type="primary" @click="confirm">确 定</el-button>
             </span>
        </el-dialog>
    </div>
</template>
<template id="videoInfo">
    <div>
        <el-dialog title="视频信息" :visible.sync="visible" width="30%">
            <el-form label-width="50px">
                <el-form-item label="av号">
                    <el-input v-model="info.aid" disabled></el-input>
                </el-form-item>
                <el-form-item label="Up主">
                    <el-input v-model="info.upName" disabled></el-input>
                </el-form-item>
                <el-form-item label="标题">
                    <el-input v-model="info.title" disabled></el-input>
                </el-form-item>
                <el-form-item label="封面">
                    <img :src="info.pic" style="height: 150px;"/>
                </el-form-item>
                <el-form-item label="简介">
                    <el-input type="textarea" v-model="info.desc" disabled></el-input>
                </el-form-item>

            </el-form>
            <span slot="footer" class="dialog-footer">
                <el-button type="primary" @click="visible = false">关闭</el-button>
             </span>
        </el-dialog>
    </div>
</template>


</body>

<script>
    const ExcludeOperator = {
        template: '#excludeOperator',
        data() {
            return {
                filterText: '',
                visible: false,
                data: operators,
                defaultProps: {
                    children: 'children',
                    label: 'name',
                }
            }
        },
        methods: {
            show() {
                this.visible = true;
            },
            filterNode(value, data) {
                if (!value) return true;
                return data.name.indexOf(value) !== -1;
            },
            confirm() {
                var arr = this.$refs.tree.getCheckedNodes();
                for (var i = 0; i < arr.length; i++) {
                    if (!arr[i].id) {
                        arr.splice(i, 1); // 将使后面的元素依次前移，数组长度减1
                        i--; // 如果不减，将漏掉一个元素
                    }
                }
                this.$emit('confirm',arr);
                this.visible = false;
            }
        },
        watch: {
            filterText(val) {
                this.$refs.tree.filter(val);
            }
        }
    };
    const AidOperator = {
        template: '#aidOperator',
        data() {
            return {
                filterText: '',
                visible: false,
                data: operators,
                defaultProps: {
                    children: 'children',
                    label: 'name',
                }
            }
        },
        methods: {
            show() {
                this.visible = true;
            },
            filterNode(value, data) {
                if (!value) return true;
                return data.name.indexOf(value) !== -1;
            },
            confirm() {
                var arr = this.$refs.tree.getCheckedNodes();
                for (var i = 0; i < arr.length; i++) {
                    if (!arr[i].id) {
                        arr.splice(i, 1); // 将使后面的元素依次前移，数组长度减1
                        i--; // 如果不减，将漏掉一个元素
                    }
                }
                this.$emit('confirm',arr);
                this.visible = false;
            }
        },
        watch: {
            filterText(val) {
                this.$refs.tree.filter(val);
            }
        }
    };

    const OperatorTableItem = {
        data(){
            return {
                visible: false,
            }
        },
        computed: {
            names: function () {
                var s = "";
                for(var i = 0; i < this.operators.length; i++) {
                    if(s) {
                        s += ",";
                    }
                    s += this.operators[i].name;
                }
                return s;
            }
        },
        filters: {
            jingying(value) {
                var arr=["精零","精一","精二"];
                return arr[value];
            },
            level(value) {
                return value + "级";
            },
            skill(value) {
                var arr=["略","一技能","二技能","三技能"];
                return arr[value];
            },
            skillLevel(value) {
                var arr=["略","rank1","rank2","rank3","rank4","rank5","rank6","rank7","专一","专二","专三"];
                return arr[value];
            },
            qianneng(value) {
                var arr = ["略","一潜","二潜","三潜","四潜","满潜"];
                return arr[value];
            }
        },
        props: ['operators'],
        template: '#operatorTableItem',
    }
    const Copy = {
        data() {
            var stageTypeListCopy = JSON.parse(JSON.stringify(stageTypeList));
            var stageMapCopy = JSON.parse(JSON.stringify(stageMap));
            stageTypeListCopy.push({"typeId":0,"description":"不限","isTag":false})
            stageMapCopy['不限']=[{"id":0,"type":0, "code":"不限"}];
            return {
                query_form: {
                    stage_id: 0,
                    total_tag: 1,
                    is_tag: false,
                    exclude_txt: '',
                    aid_txt: '',
                    exclude: [],
                    aid: [],
                    pageNo: 1,
                },
                stage_type_list: stageTypeListCopy,
                stage_map: stageMapCopy,
                stage_type: '不限',
                tableData: [],
            }
        },
        methods: {
            query() {
                var data = this.getQueryData();
                var _this = this;
                axios({
                    url:'/video/page',
                    method: 'post',
                    data: data,
                    headers:{
                        'Content-Type':'application/json'
                    }
                }).then(function(res){
                    var res = res.data;
                    if(res.status) {
                        _this.tableData = res.data;
                    } else {
                        _this.$message.error(res.message);
                    }
                }).catch(function (error) {
                    console.info(error);
                    _this.$message.error("查询异常，请联系管理员");
                });
            },
            getQueryData() {
                var aidArr = [];
                var excludeArr = [];
                var taid = this.query_form.aid;
                var texclude = this.query_form.exclude;
                for(var i = 0; i < taid.length; i++) {
                    aidArr.push(taid[i].id);
                }
                for(var i = 0; i < texclude.length; i++) {
                    excludeArr.push(texclude[i].id);
                }
                var obj = {};
                obj.stageId = this.query_form.stage_id;
                obj.minTag = this.query_form.total_tag;
                obj.isTag = this.query_form.is_tag;
                obj.pageNo = this.query_form.pageNo;
                obj.aid = aidArr;
                obj.exclude = excludeArr;
                return obj;
            },
            changeType() {
                this.query_form.stage_id = this.stage_map[this.stage_type][0].id;
                var list = this.stage_type_list;
                var type = this.stage_type;
                for (var i = 0; i < list.length; i++) {
                    if (list[i].description == type) {
                        this.query_form.is_tag = list[i].isTag;
                        break;
                    }
                }
            },
            clickEclude() {
                this.$refs.exclude_operator.show();
            },
            confirmExclude(arr) {
                if(arr.length > 0) {
                    this.query_form.exclude_txt = arr[0].name + "等" + arr.length + "名干员";
                } else {
                    this.query_form.exclude_txt = "";
                }

                this.query_form.exclude = arr;
            },
            clickAid() {
                this.$refs.aid_operator.show();
            },
            confirmAid(arr) {
                if(arr.length > 0) {
                    this.query_form.aid_txt = arr[0].name + "等" + arr.length + "名干员";
                } else {
                    this.query_form.aid_txt = "";
                }

                this.query_form.aid = arr;
            },
            jumpBili(index, row) {
                var aid = row.aid;
                window.open("https://www.bilibili.com/video/av" + aid);
            },
        },
        computed: {
            stages: function () {
                return this.stage_map[this.stage_type];
            }
        },
        created() {
            this.query();
        },
        filters: {
            longTxt(value) {
                if(value.length > 20) {
                    return value.slice(0, 20) + "...";
                } else {
                    return value;
                }
            },
            tag(value) {
                if(value <= 0) {
                    return "---";
                } else {
                    return value;
                }
            }
        },
        components: {
            'exclude-operator': ExcludeOperator,
            'aid-operator': AidOperator,
            'operator-table-item': OperatorTableItem,
        },
        template: '#copy'
    };


    const Menu = {
        data() {
            return {
                activeIndex: '1',
            };
        },
        template: '#my-menu',

    };
    const routes = [
        {path: '/抄作业', component: Copy},
        {path: '/写作业', component: Share},
        {path: '/', component: Copy}
    ];
    const router = new VueRouter({routes});
    new Vue({
        el: '#app',
        router,
        components: {
            mmenu: Menu, // 注册组件
        },
    })


</script>
</html>